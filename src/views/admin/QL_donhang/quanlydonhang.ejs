<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Đơn Hàng - BlueBook</title>

    <link rel="stylesheet" href="/admin/css/home.css" />
    <link rel="stylesheet" href="/admin/css/QL_donhang/quanlydonhang.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <span class="logo-text">BlueBook</span>
      </div>

      <div class="logo-divider"></div>

      <nav class="menu">
        <a href="/admin/home" class="menu-item">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </a>

        <div class="menu-group">
          <button class="menu-item dropdown-btn">
            <div class="menu-left">
              <i class="fa-solid fa-book"></i>
              <span>Sách</span>
            </div>
            <i class="fa-solid fa-chevron-down arrow"></i>
          </button>

          <div class="dropdown">
            <a href="/admin/quanlysach" class="menu-sub">
              <i class="fa-solid fa-list"></i> Danh sách sách
            </a>
            <a href="/admin/theloai" class="menu-sub">
              <i class="fa-solid fa-shapes"></i> Thể loại
            </a>
            <a href="/admin/thongke-tonkho" class="menu-sub">
              <i class="fa-solid fa-chart-column"></i> Thống kê tồn kho
            </a>
          </div>
        </div>

        <a href="/quanlykhachhang" class="menu-item">
          <i class="fa-solid fa-users"></i> Khách hàng
        </a>

        <a href="/admin/quanlydonhang" class="menu-item active">
          <i class="fa-solid fa-file-invoice"></i> Đơn hàng
        </a>

        <a href="/admin/doanhthu?preset=today" class="menu-item">
          <i class="fa-solid fa-coins"></i> Doanh thu
        </a>

        <a href="/logout" class="menu-item logout">
          <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
        </a>
      </nav>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      

      <div class="top-right">
        <div class="user-box">
          <i class="fa-solid fa-user"></i>
          <span class="user-name">Admin</span>
          <span class="role">Quản trị viên</span>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main">
      <div class="page-header">
        <div>
          <h1 class="page-title">Quản Lý Đơn Hàng</h1>
          <p class="page-subtitle">
            Theo dõi trạng thái và chi tiết tất cả đơn hàng trên hệ thống.
          </p>
        </div>
      </div>

      <!-- BỘ LỌC -->
      <div class="order-filters">
        <form class="filters-row" method="get" action="/admin/quanlydonhang">

          <div class="filter-group">
            <label>Trạng thái:</label>
            <select name="trangthai">
              <option value="" <%= trangthai === "" ? "selected" : "" %>>
                Tất cả
              </option>
              <option value="MOI" <%= trangthai === "MOI" ? "selected" : "" %>>
                Mới
              </option>
              <option value="HOAN_THANH" <%= trangthai === "HOAN_THANH" ? "selected" : "" %>>
                Hoàn thành
              </option>
              <option value="HUY" <%= trangthai === "HUY" ? "selected" : "" %>>
                Hủy
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label>Ngày đặt:</label>
            <input type="date" name="from" value="<%= from || '' %>">
            <span class="filter-separator">-</span>
            <input type="date" name="to" value="<%= to || '' %>">
          </div>

          <button class="filter-apply" type="submit">
            <i class="fa-solid fa-filter"></i> Lọc
          </button>
        </form>
      </div>

      <!-- BẢNG ĐƠN HÀNG -->
      <div class="table-wrap">
        <table class="order-table">
          <thead>
            <tr>
              <th>Mã ĐH</th>
              <th>Ngày đặt</th>
              <th>Tên tài khoản</th>
              <th class="text-right">Tổng tiền</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>

          <tbody>
            <% for (let i = 0; i < DS_donhang.length; i++) { %>
            <tr>
              <td>#<%= DS_donhang[i].madonhang %></td>

              <td>
                <%= new Date(DS_donhang[i].ngaymua).toLocaleString("vi-VN") %>
              </td>

              <td><%= DS_donhang[i].taikhoan %></td>

              <td class="text-right">
                <%= Number(DS_donhang[i].tongtien).toLocaleString("vi-VN") %>đ
              </td>

              <td>
                <% if (DS_donhang[i].trangthai === "MOI") { %>
                  <span class="status-badge status-new">MỚI</span>
                <% } else if (DS_donhang[i].trangthai === "HUY") { %>
                  <span class="status-badge status-cancel">HỦY</span>
                <% } else { %>
                  <span class="status-badge status-done">HOÀN THÀNH</span>
                <% } %>
              </td>

              <td class="action-cell">
                <form
                  method="post"
                  action="/admin/quanlydonhang/capnhattrangthai/<%= DS_donhang[i].madonhang %>"
                  class="status-form"
                >
                  <select name="trangthai" class="status-select">
                  <% if (DS_donhang[i].trangthai === "MOI") { %>
                  <option value="MOI" selected>Cập nhật</option><% } %>
                  <option value="HOAN_THANH" <%= DS_donhang[i].trangthai === "HOAN_THANH" ? "selected" : "" %>>Hoàn thành</option>
                  <option value="HUY" <%= DS_donhang[i].trangthai === "HUY" ? "selected" : "" %>>Hủy</option>
                  </select>

                  <button type="submit" class="btn-save" title="Lưu trạng thái">
                    <i class="fa-solid fa-check"></i>
                  </button>
                </form>

                <a
                  class="btn-view"
                  href="/admin/quanlydonhang/chitietdonhang/<%= DS_donhang[i].madonhang %>"
                  title="Xem chi tiết"
                >
                  <i class="fa-solid fa-eye"></i>
                </a>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      const btn = document.querySelector(".dropdown-btn");
      const drop = document.querySelector(".dropdown");
      const arrow = document.querySelector(".arrow");

      if (btn) {
        btn.addEventListener("click", () => {
          drop.classList.toggle("show");
          arrow.classList.toggle("rotate");
        });
      }
    </script>
  </body>
</html>
